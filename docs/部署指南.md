# 部署指南

## 🎯 概述

本指南提供在任何AWS账号中部署《S3私有桶网关代理与子目录级404重定向》的详细说明。

## 📋 前置条件

### AWS要求
- 已安装并配置AWS CLI
- 具备适当权限的AWS账号
- 目标区域中的EC2密钥对

### 所需AWS权限
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "cloudformation:*",
                "ec2:*",
                "s3:*",
                "iam:*"
            ],
            "Resource": "*"
        }
    ]
}
```

### 本地要求
- Bash shell (Linux/macOS/WSL)
- Git (用于克隆仓库)
- 互联网连接

## 🚀 部署方法

### 方法1: 一键脚本部署 (推荐)

```bash
# 克隆仓库
git clone https://github.com/your-username/s3-private-gateway-proxy.git
cd s3-private-gateway-proxy

# 使用默认设置部署
./deploy.sh 我的堆栈名称 我的密钥对名称 us-east-1

# 使用自定义实例类型部署
./deploy.sh 我的堆栈名称 我的密钥对名称 us-east-1 t3.large
```

### 方法2: AWS CLI直接部署

```bash
aws cloudformation deploy \
  --template-file infrastructure/cloudformation-template.yaml \
  --stack-name s3-private-gateway-proxy \
  --parameter-overrides \
    KeyPairName=我的密钥对 \
    ProjectName=s3-gateway \
    InstanceType=t3.medium \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-east-1
```

### 方法3: AWS控制台部署

1. 打开AWS CloudFormation控制台
2. 点击"创建堆栈" → "使用新资源"
3. 上传 `infrastructure/cloudformation-template.yaml`
4. 填写参数:
   - **堆栈名称**: `s3-private-gateway-proxy`
   - **KeyPairName**: 您的EC2密钥对名称
   - **ProjectName**: `s3-gateway`
   - **InstanceType**: `t3.medium`
5. 勾选"我确认AWS CloudFormation可能创建IAM资源"
6. 点击"创建堆栈"

## ⚙️ 配置参数

### 必需参数

| 参数 | 描述 | 示例 |
|------|------|------|
| `KeyPairName` | 用于SSH访问的EC2密钥对 | `我的密钥对` |

### 可选参数

| 参数 | 默认值 | 描述 | 选项 |
|------|--------|------|------|
| `InstanceType` | `t3.medium` | EC2实例类型 | `t3.micro`, `t3.small`, `t3.medium`, `t3.large` |
| `ProjectName` | `s3-gateway` | 资源命名前缀 | 任何字母数字字符串 |

## 🏗️ 基础设施组件

### 创建的资源

| 资源类型 | 命名模式 | 用途 |
|----------|----------|------|
| **S3桶** | `{ProjectName}-{AccountId}-{Region}` | 私有内容存储 |
| **EC2实例** | `{ProjectName}-instance` | 应用服务器 |
| **IAM角色** | `{ProjectName}-ec2-role` | S3访问权限 |
| **安全组** | `{ProjectName}-sg` | 网络访问控制 |
| **实例配置文件** | `{ProjectName}-instance-profile` | EC2-IAM集成 |

### 网络配置

- **VPC**: 使用默认VPC
- **子网**: 使用默认公有子网
- **安全组规则**:
  - SSH (22): 0.0.0.0/0
  - HTTP (80): 0.0.0.0/0
  - HTTPS (443): 0.0.0.0/0

## 📊 部署过程

### 阶段1: 基础设施 (2-3分钟)
1. 创建具有私有访问权限的S3桶
2. 创建IAM角色和策略
3. 创建安全组
4. 启动EC2实例

### 阶段2: 应用设置 (3-5分钟)
1. 安装系统包 (Nginx, Python, AWS CLI)
2. 下载并配置应用程序
3. 上传示例内容到S3
4. 启动服务 (Nginx, S3-Proxy)

### 阶段3: 验证 (1分钟)
1. 健康检查端点
2. 基础功能测试
3. 重定向功能测试

## 🧪 部署后验证

### 自动验证

部署脚本自动验证:

```bash
# 健康检查
curl -f http://$PUBLIC_IP/health

# 基础功能
curl -f http://$PUBLIC_IP/

# 重定向功能
curl -I http://$PUBLIC_IP/website1/测试404
```

### 手动验证

```bash
# 获取部署输出
aws cloudformation describe-stacks \
  --stack-name 你的堆栈名称 \
  --region 你的区域 \
  --query 'Stacks[0].Outputs'

# 测试所有端点
PUBLIC_IP="你的实例IP"

# 健康检查
curl http://$PUBLIC_IP/health
# 预期: "OK"

# 根页面
curl http://$PUBLIC_IP/
# 预期: HTML内容

# 子目录访问
curl http://$PUBLIC_IP/website1/
# 预期: website1 HTML内容

# 404重定向测试
curl -I http://$PUBLIC_IP/website1/缺失页面
# 预期: 200 OK 带重定向头

# 缓存管理
curl http://$PUBLIC_IP/admin/cache/status
# 预期: JSON缓存状态
```

## 🔧 自定义配置

### 修改S3内容

```bash
# 从堆栈输出获取桶名称
BUCKET_NAME=$(aws cloudformation describe-stacks \
  --stack-name 你的堆栈名称 \
  --region 你的区域 \
  --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
  --output text)

# 上传新内容
aws s3 cp 本地文件.html s3://$BUCKET_NAME/路径/
aws s3 sync 本地目录/ s3://$BUCKET_NAME/子目录/

# 清除缓存以立即更新
curl http://你的IP/admin/cache/clear
```

### 修改应用配置

```bash
# SSH到实例
ssh -i 你的密钥对.pem ec2-user@你的实例IP

# 编辑配置
sudo nano /opt/s3-proxy/s3-proxy.py

# 重启服务
sudo systemctl restart s3-proxy
```

### 添加SSL/TLS (手动)

```bash
# 安装certbot
sudo yum install -y certbot python3-certbot-nginx

# 获取证书 (需要域名)
sudo certbot --nginx -d 你的域名.com

# 更新安全组以支持HTTPS
aws ec2 authorize-security-group-ingress \
  --group-id 你的安全组ID \
  --protocol tcp \
  --port 443 \
  --cidr 0.0.0.0/0
```

## 🐛 故障排除

### 常见问题

#### 1. 密钥对未找到
```
错误: 在区域 'us-east-1' 中未找到密钥对 'my-keypair'
```
**解决方案**: 创建密钥对或使用现有的:
```bash
aws ec2 create-key-pair --key-name 我的密钥对 --region us-east-1
```

#### 2. 权限不足
```
错误: 用户无权执行: cloudformation:CreateStack
```
**解决方案**: 添加所需IAM权限或使用管理员访问权限。

#### 3. 实例无响应
```
curl: (7) 无法连接到IP端口80: 连接被拒绝
```
**解决方案**:
- 等待2-3分钟完成初始化
- 检查安全组规则
- 验证实例正在运行
- 检查应用日志

#### 4. S3访问被拒绝
```
错误: 访问S3桶时被拒绝
```
**解决方案**:
- 验证IAM角色权限
- 检查桶策略
- 确保实例配置文件已附加

### 调试命令

```bash
# 检查CloudFormation堆栈状态
aws cloudformation describe-stacks --stack-name 你的堆栈名称

# 检查实例状态
aws ec2 describe-instances --instance-ids 你的实例ID

# SSH到实例进行调试
ssh -i 你的密钥对.pem ec2-user@你的实例IP

# 检查应用日志
sudo journalctl -u s3-proxy -f

# 检查nginx日志
sudo tail -f /var/log/nginx/s3-proxy-error.log

# 检查系统状态
sudo systemctl status nginx s3-proxy
```

## 🔄 更新和维护

### 更新应用代码

```bash
# SSH到实例
ssh -i 你的密钥对.pem ec2-user@你的实例IP

# 备份当前版本
sudo cp /opt/s3-proxy/s3-proxy.py /opt/s3-proxy/s3-proxy.py.backup

# 更新代码 (手动编辑或下载新版本)
sudo nano /opt/s3-proxy/s3-proxy.py

# 重启服务
sudo systemctl restart s3-proxy
```

### 更新基础设施

```bash
# 更新CloudFormation堆栈
aws cloudformation deploy \
  --template-file infrastructure/cloudformation-template.yaml \
  --stack-name 你的堆栈名称 \
  --parameter-overrides KeyPairName=你的密钥对 \
  --capabilities CAPABILITY_NAMED_IAM
```

### 备份和恢复

```bash
# 备份S3内容
aws s3 sync s3://你的桶名称/ ./backup/

# 备份应用配置
scp -i 你的密钥对.pem ec2-user@你的IP:/opt/s3-proxy/s3-proxy.py ./backup/

# 从备份恢复
aws s3 sync ./backup/ s3://你的桶名称/
```

## 🗑️ 清理

### 完整清理

```bash
# 删除CloudFormation堆栈 (删除所有资源)
aws cloudformation delete-stack \
  --stack-name 你的堆栈名称 \
  --region 你的区域

# 验证删除
aws cloudformation describe-stacks \
  --stack-name 你的堆栈名称 \
  --region 你的区域
# 应该返回: 堆栈不存在
```

### 部分清理 (保留S3数据)

```bash
# 首先下载S3内容
aws s3 sync s3://你的桶名称/ ./backup/

# 删除堆栈
aws cloudformation delete-stack --stack-name 你的堆栈名称

# 将S3内容恢复到新部署
aws s3 sync ./backup/ s3://新桶名称/
```

## 📞 支持

- **文档**: 查看 `/docs` 目录
- **问题反馈**: GitHub Issues
- **社区讨论**: GitHub Discussions

---

**下一步**: 部署成功后，请查看 [API文档.md](API文档.md) 了解API使用方法，查看 [故障排除.md](故障排除.md) 了解常见问题。
